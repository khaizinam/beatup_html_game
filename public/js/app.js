(()=>{"use strict";var t={"4K":["ArrowLeft","ArrowDown","ArrowUp","ArrowRight"],"8K":["ArrowLeft","ArrowDown","ArrowUp","ArrowRight","KeyA","KeyS","KeyD","KeyF"]},e={EASY:{noteCountBonus:-1,speedMultiplier:.8},NORMAL:{noteCountBonus:0,speedMultiplier:1},HARD:{noteCountBonus:1,speedMultiplier:1.2},EXPERT:{noteCountBonus:2,speedMultiplier:1.5}},i=[{id:"sorry_bao_thi",name:"Sorry - Bảo Thy",file:"public/music/sorry_bao_thi.mp3",duration:240,segments:[{start:0,end:60,mode:1,bpm:100,label:"Warm Up"},{start:60,end:120,mode:2,bpm:130,label:"Normal"},{start:120,end:180,mode:3,bpm:160,label:"Fast"},{start:180,end:240,mode:4,bpm:190,label:"Super Fast"}]},{id:"song1",name:"Upbeat Groove",file:"public/audio/song1.mp3",duration:300,segments:[{start:0,end:60,bpm:100,label:"Intro"},{start:60,end:120,bpm:120,label:"Verse 1"},{start:120,end:180,bpm:140,label:"Chorus"},{start:180,end:240,bpm:160,label:"Bridge"},{start:240,end:300,bpm:180,label:"Outro"}]},{id:"song2",name:"Chill Beat",file:"public/audio/song2.mp3",duration:240,segments:[{start:0,end:40,bpm:80,label:"Intro"},{start:40,end:100,bpm:100,label:"Main"},{start:100,end:160,bpm:110,label:"Build Up"},{start:160,end:240,bpm:120,label:"Climax"}]}];function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function s(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,o(n.key),n)}}function o(t){var e=function(t,e){if("object"!=n(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!=n(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==n(e)?e:e+""}var r=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.sounds={key:new Audio("public/audio/key.wav"),space:new Audio("public/audio/space.wav"),perfect:new Audio("public/audio/perfect.wav"),great:new Audio("public/audio/great.wav"),bad:new Audio("public/audio/bad.wav"),miss:new Audio("public/audio/miss.wav"),start:new Audio("public/audio/game-start.mp3")},this.music=null,Object.values(this.sounds).forEach(function(t){return t.volume=.4}),this.sounds.perfect&&(this.sounds.perfect.volume=.6)},e=[{key:"playMusic",value:function(t){this.music&&this.music.pause(),this.music=new Audio(t),this.music.volume=.5,this.music.play().catch(function(t){return console.warn("Music load failed or autoplay blocked",t)})}},{key:"playBGM",value:function(){this.bgm||(this.bgm=new Audio("public/audio/background-loop.mp3"),this.bgm.loop=!0,this.bgm.volume=.3),this.bgm.paused&&this.bgm.play().catch(function(t){return console.log("BGM Auto-play blocked")})}},{key:"stopBGM",value:function(){this.bgm&&(this.bgm.pause(),this.bgm.currentTime=0)}},{key:"toggleMusic",value:function(t){this.music&&(t?this.music.play():this.music.pause())}},{key:"stopMusic",value:function(){this.music&&(this.music.pause(),this.music.currentTime=0)}},{key:"playKey",value:function(){this.play(this.sounds.key)}},{key:"playStart",value:function(){this.play(this.sounds.start)}},{key:"playJudgement",value:function(t){var e=t.toLowerCase();this.sounds[e]&&this.play(this.sounds[e])}},{key:"play",value:function(t){if(t){var e=t.cloneNode();e.volume=t.volume,e.play().catch(function(t){})}}}],e&&s(t.prototype,e),i&&s(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,i}();function a(t){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a(t)}function u(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,l(n.key),n)}}function l(t){var e=function(t,e){if("object"!=a(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=a(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==a(e)?e:e+""}var c=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.measureProgress=0,this.bpm=100,this.measureDuration=2400,this.barX=100,this.barY=500,this.barW=600,this.targetPercent=.85,this.zoneWidth=.1},(e=[{key:"updateSpeed",value:function(t){this.bpm=t,this.measureDuration=6e4/this.bpm*4}},{key:"update",value:function(t){this.measureProgress+=t/this.measureDuration,this.measureProgress>=1&&(this.game.noteSystem.hasPendingNotes()&&(this.game.triggerJudgement("MISS","red"),this.game.noteSystem.reset()),this.measureProgress=0,this.game.noteSystem.generateSequence()),this.game.config.autoPlay&&this.game.noteSystem.isComplete()&&Math.abs(this.measureProgress-this.targetPercent)<.005&&(this.game.triggerJudgement("PERFECT","#0ff"),this.game.noteSystem.reset(),this.game.audioSystem.play("space"))}},{key:"draw",value:function(t){t.fillStyle="#333",t.fillRect(this.barX,this.barY,this.barW,10);var e=this.barX+(this.targetPercent-this.zoneWidth/2)*this.barW;t.fillStyle="rgba(0, 255, 255, 0.3)",t.fillRect(e,this.barY-5,this.zoneWidth*this.barW,20);var i=this.barX+this.targetPercent*this.barW;t.fillStyle="#fff",t.fillRect(i-1,this.barY-10,2,30);var n=this.barX+this.measureProgress*this.barW;t.beginPath(),t.arc(n,this.barY+5,12,0,2*Math.PI),t.fillStyle="#0ff",t.shadowBlur=10,t.shadowColor="#0ff",t.fill(),t.shadowBlur=0,Math.abs(this.measureProgress-this.targetPercent)<this.zoneWidth/2&&(t.strokeStyle="white",t.lineWidth=2,t.stroke())}},{key:"checkTiming",value:function(){var t=Math.abs(this.measureProgress-this.targetPercent);return t<.01?"PERFECT":t<.03?"GREAT":t<.06?"COOL":t<.1?"BAD":"MISS"}}])&&u(t.prototype,e),i&&u(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,i}();function m(t){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m(t)}function h(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,f(n.key),n)}}function f(t){var e=function(t,e){if("object"!=m(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==m(e)?e:e+""}var d=function(){return i=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.sequence=[],this.inputIndex=0},(n=[{key:"generateSequence",value:function(){this.sequence=[],this.inputIndex=0;for(var i=3+Math.floor(this.game.level/2),n=e[this.game.config.diff],s=Math.min(9,i+n.noteCountBonus),o=t[this.game.config.mode],r=0;r<s;r++){var a=o[Math.floor(Math.random()*o.length)];this.sequence.push({key:a,state:"PENDING"})}this.sequence.length>0&&(this.sequence[0].state="ACTIVE")}},{key:"hasPendingNotes",value:function(){return this.sequence.some(function(t){return"DONE"!==t.state})}},{key:"reset",value:function(){this.sequence=[],this.inputIndex=0}},{key:"handleInput",value:function(t){if(0!==this.sequence.length&&!(this.inputIndex>=this.sequence.length)){var e=this.sequence[this.inputIndex];t===e.key?(e.state="DONE",this.inputIndex++,this.game.audioSystem.playKey(),this.inputIndex<this.sequence.length&&(this.sequence[this.inputIndex].state="ACTIVE")):(this.inputIndex=0,this.sequence.forEach(function(t){return t.state="PENDING"}),this.sequence.length>0&&(this.sequence[0].state="ACTIVE"),this.game.triggerJudgement("RESET","orange"))}}},{key:"updateAutoPlay",value:function(){if(this.sequence.length>0&&this.inputIndex<this.sequence.length){var t=this.sequence[this.inputIndex];(Math.random()>.8||0===this.inputIndex)&&this.handleInput(t.key)}}},{key:"isComplete",value:function(){return this.sequence.length>0&&this.inputIndex===this.sequence.length}},{key:"draw",value:function(t){var e=this,i=400-40*this.sequence.length;this.sequence.forEach(function(n,s){var o=i+80*s;t.save(),t.translate(o,300),"DONE"===n.state?t.fillStyle="#0f0":"ACTIVE"===n.state?t.fillStyle="#fff":t.fillStyle="#555",e.drawArrow(t,n.key),t.restore()})}},{key:"drawArrow",value:function(t,e){t.font="bold 40px Arial",t.textAlign="center";var i="?";"ArrowUp"===e&&(i="↑"),"ArrowDown"===e&&(i="↓"),"ArrowLeft"===e&&(i="←"),"ArrowRight"===e&&(i="→"),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e)||(i=e.replace("Key","")),t.strokeStyle="black",t.lineWidth=3,t.strokeText(i,0,10),t.fillText(i,0,10)}}])&&h(i.prototype,n),s&&h(i,s),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n,s}();function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function p(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,b(n.key),n)}}function b(t){var e=function(t,e){if("object"!=y(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==y(e)?e:e+""}var g=function(){return t=function t(e){var i=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,document.addEventListener("keydown",function(t){return i.onKeyDown(t)})},e=[{key:"onKeyDown",value:function(t){if("MENU"!==this.game.state&&"GAMEOVER"!==this.game.state)if("Escape"!==t.code){if("PLAYING"===this.game.state)if("Space"!==t.code)this.game.noteSystem.handleInput(t.code);else if(this.game.noteSystem.isComplete()){var e=this.game.beatSystem.checkTiming(),i="white";"PERFECT"===e&&(i="#0ff"),"GREAT"===e&&(i="#0f0"),"COOL"===e&&(i="#00f"),"BAD"===e&&(i="#f00"),this.game.triggerJudgement(e,i),this.game.noteSystem.reset()}else this.game.triggerJudgement("MISS","red"),this.game.noteSystem.reset()}else this.game.togglePause()}}],e&&p(t.prototype,e),i&&p(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,i}();function v(t){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v(t)}function S(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,w(n.key),n)}}function w(t){var e=function(t,e){if("object"!=v(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=v(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==v(e)?e:e+""}var E=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.scoreEl=document.getElementById("score"),this.comboEl=document.getElementById("combo"),this.levelEl=document.getElementById("level")},(e=[{key:"updateUI",value:function(){this.scoreEl.innerText=this.game.score,this.comboEl.innerText=this.game.combo,this.levelEl.innerText=this.game.level}},{key:"draw",value:function(t){var e=this,i=Math.max(0,this.game.songData.duration-this.game.elapsedTime),n=Math.floor(i/60),s=Math.floor(i%60).toString().padStart(2,"0");t.font="20px monospace",t.fillStyle="#fff",t.textAlign="center",t.fillText("TIME: ".concat(n,":").concat(s),400,30);var o=this.game.songData.segments.find(function(t){return e.game.elapsedTime>=t.start&&e.game.elapsedTime<t.end});o&&(t.font="bold 16px Arial",t.fillStyle="#FFD700",t.textAlign="center",t.fillText(o.label.toUpperCase(),400,55))}}])&&S(t.prototype,e),i&&S(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,i}();function T(t){return T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},T(t)}function k(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,A(n.key),n)}}function A(t){var e=function(t,e){if("object"!=T(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=T(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==T(e)?e:e+""}var P=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.state="MENU",this.lastTime=0,this.config={mode:"4K",diff:"NORMAL",songId:null,autoPlay:!1},this.songData=null,this.elapsedTime=0,this.score=0,this.combo=0,this.maxCombo=0,this.level=1,this.bpm=100,this.currentPhaseIdx=0,this.audioSystem=new r,this.beatSystem=new c(this),this.noteSystem=new d(this),this.inputSystem=new g(this),this.uiSystem=new E(this),this.initMenu(),this.audioSystem.playBGM(),this.loop=this.loop.bind(this),requestAnimationFrame(this.loop)},(n=[{key:"initMenu",value:function(){var t=this,e=document.getElementById("setting-song");e.innerHTML="",i.forEach(function(t){var i=document.createElement("option");i.value=t.id,i.innerText=t.name,e.appendChild(i)}),document.getElementById("btn-start").onclick=function(){return t.startGame()},document.getElementById("btn-resume").onclick=function(){return t.resumeGame()},document.getElementById("btn-menu").onclick=function(){return t.quitToMenu()},document.getElementById("btn-home").onclick=function(){return t.showScreen("screen-menu")},document.getElementById("btn-replay").onclick=function(){return t.startGame()},this.showScreen("screen-menu")}},{key:"startGame",value:function(){var t=this;if(this.config.mode=document.getElementById("setting-mode").value,this.config.diff=document.getElementById("setting-diff").value,this.config.songId=document.getElementById("setting-song").value,this.config.autoPlay=document.getElementById("setting-auto").checked,this.songData=i.find(function(e){return e.id===t.config.songId}),!this.songData)return alert("Song not found!");this.score=0,this.combo=0,this.maxCombo=0,this.level=1,this.elapsedTime=0,this.currentPhaseIdx=0,this.bpm=this.songData.segments[0].bpm,this.beatSystem.updateSpeed(this.bpm),this.beatSystem.updateSpeed(this.bpm),this.noteSystem.reset(),this.audioSystem.stopBGM(),this.state="STARTING",this.audioSystem.playStart(),this.showScreen("screen-game"),setTimeout(function(){"STARTING"===t.state&&(t.audioSystem.playMusic(t.songData.file),t.state="PLAYING",t.elapsedTime=0)},2e3)}},{key:"togglePause",value:function(){"PLAYING"===this.state?(this.state="PAUSED",this.audioSystem.toggleMusic(!1),document.getElementById("modal-pause").classList.remove("hidden")):"PAUSED"===this.state&&this.resumeGame()}},{key:"resumeGame",value:function(){this.state="PLAYING",this.audioSystem.toggleMusic(!0),document.getElementById("modal-pause").classList.add("hidden")}},{key:"quitToMenu",value:function(){this.state="MENU",this.audioSystem.stopMusic(),this.audioSystem.playBGM(),this.showScreen("screen-menu"),document.getElementById("modal-pause").classList.add("hidden")}},{key:"endGame",value:function(){this.state="GAMEOVER",this.audioSystem.stopMusic(),this.audioSystem.playBGM(),this.showScreen("screen-result"),document.getElementById("res-song").innerText=this.songData.name,document.getElementById("res-score").innerText=this.score,document.getElementById("res-combo").innerText=this.maxCombo;var t="F";this.score>5e4?t="S":this.score>3e4?t="A":this.score>1e4&&(t="B"),document.getElementById("res-rank").innerText=t}},{key:"showScreen",value:function(t){document.querySelectorAll(".screen").forEach(function(t){return t.classList.remove("active")}),document.getElementById(t).classList.add("active")}},{key:"loop",value:function(t){var e=t-this.lastTime;if(this.lastTime=t,"PLAYING"===this.state){var i=this.audioSystem.music?this.audioSystem.music.currentTime:this.elapsedTime;Math.abs(i-this.elapsedTime)>.1?this.elapsedTime=i:this.elapsedTime+=e/1e3,this.update(e),this.draw()}else"PAUSED"===this.state?this.draw():"STARTING"===this.state&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground(),this.ctx.fillStyle="white",this.ctx.font="bold 40px Arial",this.ctx.textAlign="center",this.ctx.fillText("READY...",400,300));requestAnimationFrame(this.loop)}},{key:"update",value:function(t){var e=this;if(this.elapsedTime>=this.songData.duration)this.endGame();else{var i=this.songData.segments.find(function(t){return e.elapsedTime>=t.start&&e.elapsedTime<t.end});i&&i.bpm!==this.bpm&&(this.bpm=i.bpm,this.beatSystem.updateSpeed(this.bpm),this.triggerJudgement(i.label,"#FFD700")),this.config.autoPlay&&this.noteSystem.updateAutoPlay(),this.beatSystem.update(t)}}},{key:"draw",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground(),this.beatSystem.draw(this.ctx),this.noteSystem.draw(this.ctx),this.uiSystem.draw(this.ctx)}},{key:"drawBackground",value:function(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.strokeStyle="#222",this.ctx.lineWidth=1;for(var t=0;t<800;t+=40)this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,600),this.ctx.stroke();for(var e=0;e<600;e+=40)this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(800,e),this.ctx.stroke();this.ctx.restore()}},{key:"triggerJudgement",value:function(t,i){var n=document.getElementById("judgement");if(n.innerText=t,n.style.color=i,n.style.transform="translateX(-50%) scale(1.5)",setTimeout(function(){return n.style.transform="translateX(-50%) scale(1)"},100),["PERFECT","GREAT","COOL","BAD","MISS"].includes(t)&&this.audioSystem.playJudgement(t),"MISS"===t||"BAD"===t||"RESET"===t)this.combo=0;else if(["PERFECT","GREAT","COOL"].includes(t)){this.combo++,this.combo>this.maxCombo&&(this.maxCombo=this.combo);var s=0;"PERFECT"===t&&(s=1e3),"GREAT"===t&&(s=500),"COOL"===t&&(s=100);var o=e[this.config.diff].noteCountBonus+1;this.score+=s*(1+Math.floor(this.combo/10))*o}this.uiSystem.updateUI()}}])&&k(t.prototype,n),s&&k(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,s}();window.onload=function(){window.game=new P}})();