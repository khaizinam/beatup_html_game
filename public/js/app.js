(()=>{"use strict";var e={"4K":["ArrowLeft","ArrowDown","ArrowUp","ArrowRight"],"8K":["ArrowLeft","ArrowDown","ArrowUp","ArrowRight","KeyA","KeyS","KeyD","KeyF"]},t={EASY:{noteCountBonus:-1,speedMultiplier:.8},NORMAL:{noteCountBonus:0,speedMultiplier:1},HARD:{noteCountBonus:1,speedMultiplier:1.2},EXPERT:{noteCountBonus:2,speedMultiplier:1.5}},i=[{id:"sorry_bao_thi",name:"Sorry - Bảo Thy",file:"public/music/sorry_bao_thi.mp3",duration:240,segments:[{start:0,end:60,mode:1,bpm:100,label:"Warm Up"},{start:60,end:120,mode:2,bpm:130,label:"Normal"},{start:120,end:180,mode:3,bpm:160,label:"Fast"},{start:180,end:240,mode:4,bpm:190,label:"Super Fast"}]},{id:"song1",name:"Upbeat Groove",file:"public/audio/song1.mp3",duration:300,segments:[{start:0,end:60,bpm:100,label:"Intro"},{start:60,end:120,bpm:120,label:"Verse 1"},{start:120,end:180,bpm:140,label:"Chorus"},{start:180,end:240,bpm:160,label:"Bridge"},{start:240,end:300,bpm:180,label:"Outro"}]},{id:"song2",name:"Chill Beat",file:"public/audio/song2.mp3",duration:240,segments:[{start:0,end:40,bpm:80,label:"Intro"},{start:40,end:100,bpm:100,label:"Main"},{start:100,end:160,bpm:110,label:"Build Up"},{start:160,end:240,bpm:120,label:"Climax"}]}];function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,r(n.key),n)}}function r(e){var t=function(e,t){if("object"!=n(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!=n(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==n(t)?t:t+""}var s=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sounds={key:new Audio("public/audio/key.wav"),space:new Audio("public/audio/space.wav"),perfect:new Audio("public/audio/perfect.wav"),great:new Audio("public/audio/great.wav"),bad:new Audio("public/audio/bad.wav"),miss:new Audio("public/audio/miss.wav")},this.music=null,Object.values(this.sounds).forEach(function(e){return e.volume=.4}),this.sounds.perfect&&(this.sounds.perfect.volume=.6)},t=[{key:"playMusic",value:function(e){this.music&&this.music.pause(),this.music=new Audio(e),this.music.volume=.5,this.music.play().catch(function(e){return console.warn("Music load failed or autoplay blocked",e)})}},{key:"toggleMusic",value:function(e){this.music&&(e?this.music.play():this.music.pause())}},{key:"stopMusic",value:function(){this.music&&(this.music.pause(),this.music.currentTime=0)}},{key:"playKey",value:function(){this.play(this.sounds.key)}},{key:"playJudgement",value:function(e){var t=e.toLowerCase();this.sounds[t]&&this.play(this.sounds[t])}},{key:"play",value:function(e){if(e){var t=e.cloneNode();t.volume=e.volume,t.play().catch(function(e){})}}}],t&&o(e.prototype,t),i&&o(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i}();function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function u(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,l(n.key),n)}}function l(e){var t=function(e,t){if("object"!=a(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=a(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==a(t)?t:t+""}var c=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.measureProgress=0,this.bpm=100,this.measureDuration=2400,this.barX=100,this.barY=500,this.barW=600,this.targetPercent=.85,this.zoneWidth=.1},(t=[{key:"updateSpeed",value:function(e){this.bpm=e,this.measureDuration=6e4/this.bpm*4}},{key:"update",value:function(e){this.measureProgress+=e/this.measureDuration,this.measureProgress>=1&&(this.game.noteSystem.hasPendingNotes()&&(this.game.triggerJudgement("MISS","red"),this.game.noteSystem.reset()),this.measureProgress=0,this.game.noteSystem.generateSequence()),this.game.config.autoPlay&&this.game.noteSystem.isComplete()&&Math.abs(this.measureProgress-this.targetPercent)<.005&&(this.game.triggerJudgement("PERFECT","#0ff"),this.game.noteSystem.reset(),this.game.audioSystem.play("space"))}},{key:"draw",value:function(e){e.fillStyle="#333",e.fillRect(this.barX,this.barY,this.barW,10);var t=this.barX+(this.targetPercent-this.zoneWidth/2)*this.barW;e.fillStyle="rgba(0, 255, 255, 0.3)",e.fillRect(t,this.barY-5,this.zoneWidth*this.barW,20);var i=this.barX+this.targetPercent*this.barW;e.fillStyle="#fff",e.fillRect(i-1,this.barY-10,2,30);var n=this.barX+this.measureProgress*this.barW;e.beginPath(),e.arc(n,this.barY+5,12,0,2*Math.PI),e.fillStyle="#0ff",e.shadowBlur=10,e.shadowColor="#0ff",e.fill(),e.shadowBlur=0,Math.abs(this.measureProgress-this.targetPercent)<this.zoneWidth/2&&(e.strokeStyle="white",e.lineWidth=2,e.stroke())}},{key:"checkTiming",value:function(){var e=Math.abs(this.measureProgress-this.targetPercent);return e<.01?"PERFECT":e<.03?"GREAT":e<.06?"COOL":e<.1?"BAD":"MISS"}}])&&u(e.prototype,t),i&&u(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i}();function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function h(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,f(n.key),n)}}function f(e){var t=function(e,t){if("object"!=m(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==m(t)?t:t+""}var d=function(){return i=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.sequence=[],this.inputIndex=0},(n=[{key:"generateSequence",value:function(){this.sequence=[],this.inputIndex=0;for(var i=3+Math.floor(this.game.level/2),n=t[this.game.config.diff],o=Math.min(9,i+n.noteCountBonus),r=e[this.game.config.mode],s=0;s<o;s++){var a=r[Math.floor(Math.random()*r.length)];this.sequence.push({key:a,state:"PENDING"})}this.sequence.length>0&&(this.sequence[0].state="ACTIVE")}},{key:"hasPendingNotes",value:function(){return this.sequence.some(function(e){return"DONE"!==e.state})}},{key:"reset",value:function(){this.sequence=[],this.inputIndex=0}},{key:"handleInput",value:function(e){if(0!==this.sequence.length){var t=this.sequence[this.inputIndex];e===t.key?(t.state="DONE",this.inputIndex++,this.game.audioSystem.playKey(),this.inputIndex<this.sequence.length&&(this.sequence[this.inputIndex].state="ACTIVE")):(this.inputIndex=0,this.sequence.forEach(function(e){return e.state="PENDING"}),this.sequence.length>0&&(this.sequence[0].state="ACTIVE"),this.game.triggerJudgement("RESET","orange"))}}},{key:"updateAutoPlay",value:function(){if(this.sequence.length>0&&this.inputIndex<this.sequence.length){var e=this.sequence[this.inputIndex];(Math.random()>.8||0===this.inputIndex)&&this.handleInput(e.key)}}},{key:"isComplete",value:function(){return this.sequence.length>0&&this.inputIndex===this.sequence.length}},{key:"draw",value:function(e){var t=this,i=400-40*this.sequence.length;this.sequence.forEach(function(n,o){var r=i+80*o;e.save(),e.translate(r,300),"DONE"===n.state?e.fillStyle="#0f0":"ACTIVE"===n.state?e.fillStyle="#fff":e.fillStyle="#555",t.drawArrow(e,n.key),e.restore()})}},{key:"drawArrow",value:function(e,t){e.font="bold 40px Arial",e.textAlign="center";var i="?";"ArrowUp"===t&&(i="↑"),"ArrowDown"===t&&(i="↓"),"ArrowLeft"===t&&(i="←"),"ArrowRight"===t&&(i="→"),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(t)||(i=t.replace("Key","")),e.strokeStyle="black",e.lineWidth=3,e.strokeText(i,0,10),e.fillText(i,0,10)}}])&&h(i.prototype,n),o&&h(i,o),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n,o}();function y(e){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y(e)}function p(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,b(n.key),n)}}function b(e){var t=function(e,t){if("object"!=y(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==y(t)?t:t+""}var g=function(){return e=function e(t){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,document.addEventListener("keydown",function(e){return i.onKeyDown(e)})},t=[{key:"onKeyDown",value:function(e){if("MENU"!==this.game.state&&"GAMEOVER"!==this.game.state)if("Escape"!==e.code){if("PLAYING"===this.game.state)if("Space"!==e.code)this.game.noteSystem.handleInput(e.code);else if(this.game.noteSystem.isComplete()){var t=this.game.beatSystem.checkTiming(),i="white";"PERFECT"===t&&(i="#0ff"),"GREAT"===t&&(i="#0f0"),"COOL"===t&&(i="#00f"),"BAD"===t&&(i="#f00"),this.game.triggerJudgement(t,i),this.game.noteSystem.reset()}else this.game.triggerJudgement("MISS","red"),this.game.noteSystem.reset()}else this.game.togglePause()}}],t&&p(e.prototype,t),i&&p(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i}();function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function S(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,w(n.key),n)}}function w(e){var t=function(e,t){if("object"!=v(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=v(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==v(t)?t:t+""}var E=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.scoreEl=document.getElementById("score"),this.comboEl=document.getElementById("combo"),this.levelEl=document.getElementById("level")},(t=[{key:"updateUI",value:function(){this.scoreEl.innerText=this.game.score,this.comboEl.innerText=this.game.combo,this.levelEl.innerText=this.game.level}},{key:"draw",value:function(e){var t=Math.max(0,this.game.songData.duration-this.game.elapsedTime),i=Math.floor(t/60),n=Math.floor(t%60).toString().padStart(2,"0");e.font="20px monospace",e.fillStyle="#fff",e.textAlign="right",e.fillText("TIME: ".concat(i,":").concat(n),780,50)}}])&&S(e.prototype,t),i&&S(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,i}();function P(e){return P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},P(e)}function T(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,k(n.key),n)}}function k(e){var t=function(e,t){if("object"!=P(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=P(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==P(t)?t:t+""}var I=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.state="MENU",this.lastTime=0,this.config={mode:"4K",diff:"NORMAL",songId:null,autoPlay:!1},this.songData=null,this.elapsedTime=0,this.score=0,this.combo=0,this.maxCombo=0,this.level=1,this.bpm=100,this.currentPhaseIdx=0,this.audioSystem=new s,this.beatSystem=new c(this),this.noteSystem=new d(this),this.inputSystem=new g(this),this.uiSystem=new E(this),this.initMenu(),this.loop=this.loop.bind(this),requestAnimationFrame(this.loop)},(n=[{key:"initMenu",value:function(){var e=this,t=document.getElementById("setting-song");t.innerHTML="",i.forEach(function(e){var i=document.createElement("option");i.value=e.id,i.innerText=e.name,t.appendChild(i)}),document.getElementById("btn-start").onclick=function(){return e.startGame()},document.getElementById("btn-resume").onclick=function(){return e.resumeGame()},document.getElementById("btn-menu").onclick=function(){return e.quitToMenu()},document.getElementById("btn-home").onclick=function(){return e.showScreen("screen-menu")},document.getElementById("btn-replay").onclick=function(){return e.startGame()},this.showScreen("screen-menu")}},{key:"startGame",value:function(){var e=this;if(this.config.mode=document.getElementById("setting-mode").value,this.config.diff=document.getElementById("setting-diff").value,this.config.songId=document.getElementById("setting-song").value,this.config.autoPlay=document.getElementById("setting-auto").checked,this.songData=i.find(function(t){return t.id===e.config.songId}),!this.songData)return alert("Song not found!");this.score=0,this.combo=0,this.maxCombo=0,this.level=1,this.elapsedTime=0,this.currentPhaseIdx=0,this.bpm=this.songData.segments[0].bpm,this.beatSystem.updateSpeed(this.bpm),this.noteSystem.reset(),this.audioSystem.playMusic(this.songData.file),this.state="PLAYING",this.showScreen("screen-game")}},{key:"togglePause",value:function(){"PLAYING"===this.state?(this.state="PAUSED",this.audioSystem.toggleMusic(!1),document.getElementById("modal-pause").classList.remove("hidden")):"PAUSED"===this.state&&this.resumeGame()}},{key:"resumeGame",value:function(){this.state="PLAYING",this.audioSystem.toggleMusic(!0),document.getElementById("modal-pause").classList.add("hidden")}},{key:"quitToMenu",value:function(){this.state="MENU",this.audioSystem.stopMusic(),this.showScreen("screen-menu"),document.getElementById("modal-pause").classList.add("hidden")}},{key:"endGame",value:function(){this.state="GAMEOVER",this.audioSystem.stopMusic(),this.showScreen("screen-result"),document.getElementById("res-song").innerText=this.songData.name,document.getElementById("res-score").innerText=this.score,document.getElementById("res-combo").innerText=this.maxCombo;var e="F";this.score>5e4?e="S":this.score>3e4?e="A":this.score>1e4&&(e="B"),document.getElementById("res-rank").innerText=e}},{key:"showScreen",value:function(e){document.querySelectorAll(".screen").forEach(function(e){return e.classList.remove("active")}),document.getElementById(e).classList.add("active")}},{key:"loop",value:function(e){var t=e-this.lastTime;if(this.lastTime=e,"PLAYING"===this.state){var i=this.audioSystem.music?this.audioSystem.music.currentTime:this.elapsedTime;Math.abs(i-this.elapsedTime)>.1?this.elapsedTime=i:this.elapsedTime+=t/1e3,this.update(t),this.draw()}else"PAUSED"===this.state&&this.draw();requestAnimationFrame(this.loop)}},{key:"update",value:function(e){var t=this;if(this.elapsedTime>=this.songData.duration)this.endGame();else{var i=this.songData.segments.find(function(e){return t.elapsedTime>=e.start&&t.elapsedTime<e.end});i&&i.bpm!==this.bpm&&(this.bpm=i.bpm,this.beatSystem.updateSpeed(this.bpm),this.triggerJudgement(i.label,"#FFD700")),this.config.autoPlay&&this.noteSystem.updateAutoPlay(),this.beatSystem.update(e)}}},{key:"draw",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBackground(),this.beatSystem.draw(this.ctx),this.noteSystem.draw(this.ctx),this.uiSystem.draw(this.ctx)}},{key:"drawBackground",value:function(){this.ctx.fillStyle="#111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.strokeStyle="#222",this.ctx.lineWidth=1;for(var e=0;e<800;e+=40)this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,600),this.ctx.stroke();for(var t=0;t<600;t+=40)this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(800,t),this.ctx.stroke();this.ctx.restore()}},{key:"triggerJudgement",value:function(e,i){var n=document.getElementById("judgement");if(n.innerText=e,n.style.color=i,n.style.transform="translateX(-50%) scale(1.5)",setTimeout(function(){return n.style.transform="translateX(-50%) scale(1)"},100),["PERFECT","GREAT","COOL","BAD","MISS"].includes(e)&&this.audioSystem.playJudgement(e),"MISS"===e||"BAD"===e||"RESET"===e)this.combo=0;else if(["PERFECT","GREAT","COOL"].includes(e)){this.combo++,this.combo>this.maxCombo&&(this.maxCombo=this.combo);var o=0;"PERFECT"===e&&(o=1e3),"GREAT"===e&&(o=500),"COOL"===e&&(o=100);var r=t[this.config.diff].noteCountBonus+1;this.score+=o*(1+Math.floor(this.combo/10))*r}this.uiSystem.updateUI()}}])&&T(e.prototype,n),o&&T(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,o}();window.onload=function(){window.game=new I}})();